# -=-=-=-=-=-=-=-=-=-=-=
# coding=UTF-8
# __author__='Guo Jun'
# Version 1..0.0
# -=-=-=-=-=-=-=-=-=-=-=

from datetime import datetime, timedelta
from ConnectDB import get_all_data

items = 'max(date)'
table = 'idx_price'
condition = ' where symbol =\'000001.SH\' group by symbol'
idx_data = get_all_data(items, table, condition)
current_date = idx_data[0][0].strftime('%Y-%m-%d')

# current_date = '2018-04-13'strftime('%Y-%m-%d')
def get_stock_list(current_date):
    ## step 1, 过滤次新股、黑名单股和东三省的股票
    pre_year_date = (datetime.now() - timedelta(days=365)).strftime('%Y-%m-%d')
    items = 'symbol'
    table = 'stk_info'
    condition = 'where ipo  < \'' + pre_year_date + '\' and symbol not in (select symbol from data.b_list) and area not in (\'黑龙江\',\'吉林\',\'辽宁\') order by symbol'
    symbol_data = get_all_data(items, table, condition)
    stock_list = []
    for i in symbol_data:
        stock_list.append(i[0])

    ## step 2, 过滤小市值股票，市值不能低于150亿(小公司，知名度低，公开性和公平度相对较差，商业护城河较差，成长性也不高，交易流动性一般也较低）,以及交易量为0的股票
    mkt_value = 150
    items = 'symbol'
    table = 'stk_price'
    condition = 'where date = \'' + current_date + '\' and symbol in (' + str(stock_list).replace('[','').replace(']','') + ') and mktcap > \'' + str(mkt_value*100000000) + '\' and volume <> 0 order by symbol'
    symbol_data_mkt = get_all_data(items, table, condition)
    stock_list_mkt = []
    for i in symbol_data_mkt:
        stock_list_mkt.append(i[0])

    ## step3, 过滤巨大值(不超过100）或者负值的PE，PB
    items = 'symbol'
    table = 'stk_ratio'
    condition = 'where date = \'' + current_date + '\' and symbol in (' + str(stock_list_mkt).replace('[', '').replace(']','') + ') and pe_ttm>0 and pe_ttm<100 and pb>0 and pb<100 order by symbol'
    symbol_data_be = get_all_data(items, table, condition)
    stock_list_be = []
    for i in symbol_data_be:
        stock_list_be.append(i[0])

    return(stock_list_be)
## step4,


# list = get_stock_list(current_date)
# print(list)

valid_list = ['000001.SZ','000002.SZ','000006.SZ','000008.SZ','000009.SZ','000012.SZ','000021.SZ','000025.SZ','000027.SZ','000028.SZ','000031.SZ','000039.SZ','000049.SZ','000060.SZ','000061.SZ','000062.SZ','000063.SZ','000066.SZ','000069.SZ','000078.SZ','000089.SZ','000090.SZ','000100.SZ','000156.SZ','000157.SZ','000158.SZ','000166.SZ','000333.SZ','000338.SZ','000400.SZ','000401.SZ','000402.SZ','000413.SZ','000415.SZ','000418.SZ','000423.SZ','000425.SZ','000426.SZ','000488.SZ','000501.SZ','000503.SZ','000513.SZ','000519.SZ','000528.SZ','000536.SZ','000538.SZ','000540.SZ','000541.SZ','000543.SZ','000547.SZ','000552.SZ','000553.SZ','000559.SZ','000563.SZ','000566.SZ','000568.SZ','000572.SZ','000581.SZ','000587.SZ','000592.SZ','000596.SZ','000598.SZ','000600.SZ','000612.SZ','000623.SZ','000625.SZ','000627.SZ','000630.SZ','000636.SZ','000651.SZ','000656.SZ','000661.SZ','000667.SZ','000671.SZ','000681.SZ','000685.SZ','000686.SZ','000690.SZ','000703.SZ','000709.SZ','000712.SZ','000718.SZ','000723.SZ','000725.SZ','000727.SZ','000728.SZ','000729.SZ','000732.SZ','000738.SZ','000750.SZ','000758.SZ','000761.SZ','000762.SZ','000766.SZ','000768.SZ','000776.SZ','000778.SZ','000783.SZ','000786.SZ','000792.SZ','000806.SZ','000807.SZ','000813.SZ','000825.SZ','000826.SZ','000829.SZ','000830.SZ','000839.SZ','000848.SZ','000858.SZ','000860.SZ','000876.SZ','000877.SZ','000878.SZ','000887.SZ','000895.SZ','000898.SZ','000926.SZ','000930.SZ','000937.SZ','000938.SZ','000959.SZ','000960.SZ','000961.SZ','000963.SZ','000969.SZ','000970.SZ','000975.SZ','000977.SZ','000979.SZ','000980.SZ','000983.SZ','000987.SZ','000988.SZ','000990.SZ','000997.SZ','000999.SZ','001696.SZ','001965.SZ','001979.SZ','002002.SZ','002004.SZ','002007.SZ','002008.SZ','002011.SZ','002013.SZ','002019.SZ','002022.SZ','002024.SZ','002027.SZ','002028.SZ','002030.SZ','002038.SZ','002041.SZ','002044.SZ','002048.SZ','002049.SZ','002050.SZ','002051.SZ','002056.SZ','002064.SZ','002065.SZ','002073.SZ','002074.SZ','002078.SZ','002081.SZ','002085.SZ','002092.SZ','002093.SZ','002110.SZ','002118.SZ','002127.SZ','002128.SZ','002129.SZ','002131.SZ','002142.SZ','002146.SZ','002147.SZ','002152.SZ','002153.SZ','002155.SZ','002174.SZ','002176.SZ','002179.SZ','002180.SZ','002183.SZ','002190.SZ','002191.SZ','002195.SZ','002202.SZ','002212.SZ','002221.SZ','002223.SZ','002230.SZ','002233.SZ','002236.SZ','002241.SZ','002242.SZ','002244.SZ','002249.SZ','002250.SZ','002251.SZ','002252.SZ','002254.SZ','002261.SZ','002266.SZ','002268.SZ','002273.SZ','002276.SZ','002277.SZ','002280.SZ','002281.SZ','002285.SZ','002294.SZ','002299.SZ','002302.SZ','002304.SZ','002308.SZ','002310.SZ','002317.SZ','002332.SZ','002340.SZ','002342.SZ','002344.SZ','002345.SZ','002352.SZ','002353.SZ','002354.SZ','002358.SZ','002359.SZ','002366.SZ','002368.SZ','002371.SZ','002373.SZ','002375.SZ','002384.SZ','002385.SZ','002390.SZ','002399.SZ','002400.SZ','002407.SZ','002408.SZ','002410.SZ','002411.SZ','002414.SZ','002415.SZ','002416.SZ','002424.SZ','002426.SZ','002428.SZ','002431.SZ','002434.SZ','002437.SZ','002439.SZ','002440.SZ','002444.SZ','002450.SZ','002456.SZ','002460.SZ','002463.SZ','002465.SZ','002466.SZ','002468.SZ','002470.SZ','002475.SZ','002477.SZ','002479.SZ','002482.SZ','002489.SZ','002491.SZ','002493.SZ','002500.SZ','002503.SZ','002505.SZ','002506.SZ','002508.SZ','002509.SZ','002512.SZ','002517.SZ','002544.SZ','002555.SZ','002558.SZ','002563.SZ','002572.SZ','002573.SZ','002583.SZ','002588.SZ','002589.SZ','002594.SZ','002600.SZ','002601.SZ','002602.SZ','002603.SZ','002608.SZ','002624.SZ','002625.SZ','002635.SZ','002640.SZ','002642.SZ','002657.SZ','002663.SZ','002665.SZ','002670.SZ','002672.SZ','002673.SZ','002681.SZ','002690.SZ','002699.SZ','002701.SZ','002707.SZ','002709.SZ','002714.SZ','002736.SZ','002739.SZ','002745.SZ','002797.SZ','002807.SZ','002815.SZ','002818.SZ','002831.SZ','002839.SZ','002841.SZ','002916.SZ','002920.SZ','002925.SZ','300001.SZ','300002.SZ','300003.SZ','300010.SZ','300015.SZ','300017.SZ','300024.SZ','300026.SZ','300027.SZ','300032.SZ','300033.SZ','300039.SZ','300043.SZ','300055.SZ','300058.SZ','300059.SZ','300070.SZ','300072.SZ','300088.SZ','300113.SZ','300115.SZ','300116.SZ','300122.SZ','300124.SZ','300133.SZ','300134.SZ','300136.SZ','300144.SZ','300146.SZ','300156.SZ','300159.SZ','300166.SZ','300182.SZ','300197.SZ','300199.SZ','300202.SZ','300244.SZ','300251.SZ','300253.SZ','300257.SZ','300266.SZ','300273.SZ','300274.SZ','300287.SZ','300291.SZ','300297.SZ','300308.SZ','300315.SZ','300324.SZ','300376.SZ','300383.SZ','300408.SZ','300418.SZ','300433.SZ','600000.SH','600004.SH','600006.SH','600007.SH','600008.SH','600009.SH','600010.SH','600011.SH','600012.SH','600015.SH','600016.SH','600017.SH','600018.SH','600019.SH','600020.SH','600021.SH','600022.SH','600023.SH','600025.SH','600026.SH','600027.SH','600028.SH','600029.SH','600030.SH','600031.SH','600036.SH','600037.SH','600038.SH','600039.SH','600048.SH','600050.SH','600053.SH','600054.SH','600056.SH','600058.SH','600060.SH','600061.SH','600062.SH','600064.SH','600066.SH','600068.SH','600072.SH','600073.SH','600075.SH','600079.SH','600085.SH','600086.SH','600089.SH','600093.SH','600094.SH','600098.SH','600100.SH','600104.SH','600105.SH','600108.SH','600109.SH','600111.SH','600114.SH','600115.SH','600116.SH','600118.SH','600120.SH','600122.SH','600123.SH','600125.SH','600126.SH','600138.SH','600141.SH','600143.SH','600151.SH','600153.SH','600155.SH','600157.SH','600158.SH','600160.SH','600161.SH','600162.SH','600166.SH','600167.SH','600169.SH','600170.SH','600171.SH','600172.SH','600175.SH','600176.SH','600177.SH','600179.SH','600180.SH','600183.SH','600184.SH','600185.SH','600187.SH','600188.SH','600195.SH','600196.SH','600197.SH','600200.SH','600201.SH','600206.SH','600208.SH','600210.SH','600216.SH','600219.SH','600221.SH','600230.SH','600231.SH','600233.SH','600236.SH','600239.SH','600240.SH','600252.SH','600255.SH','600256.SH','600258.SH','600259.SH','600260.SH','600261.SH','600266.SH','600267.SH','600269.SH','600270.SH','600271.SH','600273.SH','600276.SH','600277.SH','600280.SH','600282.SH','600284.SH','600285.SH','600291.SH','600292.SH','600295.SH','600297.SH','600298.SH','600299.SH','600300.SH','600305.SH','600307.SH','600309.SH','600310.SH','600312.SH','600315.SH','600316.SH','600317.SH','600323.SH','600325.SH','600326.SH','600329.SH','600332.SH','600335.SH','600337.SH','600338.SH','600339.SH','600340.SH','600343.SH','600345.SH','600346.SH','600348.SH','600350.SH','600352.SH','600362.SH','600363.SH','600366.SH','600369.SH','600372.SH','600373.SH','600376.SH','600377.SH','600380.SH','600383.SH','600387.SH','600388.SH','600390.SH','600391.SH','600392.SH','600393.SH','600395.SH','600398.SH','600400.SH','600406.SH','600409.SH','600410.SH','600415.SH','600416.SH','600418.SH','600420.SH','600422.SH','600426.SH','600428.SH','600435.SH','600436.SH','600438.SH','600439.SH','600446.SH','600452.SH','600458.SH','600459.SH','600460.SH','600466.SH','600477.SH','600478.SH','600481.SH','600482.SH','600483.SH','600486.SH','600487.SH','600489.SH','600490.SH','600491.SH','600495.SH','600497.SH','600498.SH','600499.SH','600500.SH','600502.SH','600503.SH','600507.SH','600511.SH','600516.SH','600517.SH','600518.SH','600519.SH','600521.SH','600522.SH','600525.SH','600526.SH','600528.SH','600531.SH','600535.SH','600536.SH','600545.SH','600547.SH','600548.SH','600549.SH','600551.SH','600557.SH','600559.SH','600562.SH','600563.SH','600565.SH','600566.SH','600567.SH','600568.SH','600570.SH','600572.SH','600575.SH','600577.SH','600578.SH','600580.SH','600582.SH','600583.SH','600584.SH','600585.SH','600587.SH','600588.SH','600594.SH','600596.SH','600597.SH','600598.SH','600600.SH','600606.SH','600611.SH','600612.SH','600614.SH','600618.SH','600623.SH','600626.SH','600633.SH','600635.SH','600637.SH','600639.SH','600640.SH','600641.SH','600642.SH','600643.SH','600645.SH','600648.SH','600649.SH','600651.SH','600655.SH','600657.SH','600660.SH','600661.SH','600663.SH','600664.SH','600667.SH','600668.SH','600673.SH','600674.SH','600682.SH','600684.SH','600685.SH','600687.SH','600688.SH','600690.SH','600693.SH','600694.SH','600699.SH','600703.SH','600704.SH','600705.SH','600708.SH','600711.SH','600715.SH','600717.SH','600718.SH','600720.SH','600729.SH','600737.SH','600739.SH','600741.SH','600742.SH','600743.SH','600748.SH','600750.SH','600751.SH','600754.SH','600755.SH','600756.SH','600757.SH','600758.SH','600759.SH','600760.SH','600763.SH','600765.SH','600770.SH','600773.SH','600777.SH','600779.SH','600782.SH','600787.SH','600795.SH','600801.SH','600803.SH','600804.SH','600808.SH','600809.SH','600811.SH','600814.SH','600816.SH','600820.SH','600823.SH','600826.SH','600827.SH','600828.SH','600829.SH','600835.SH','600837.SH','600838.SH','600839.SH','600846.SH','600848.SH','600850.SH','600856.SH','600859.SH','600862.SH','600863.SH','600867.SH','600869.SH','600872.SH','600874.SH','600875.SH','600879.SH','600881.SH','600884.SH','600885.SH','600886.SH','600887.SH','600893.SH','600895.SH','600897.SH','600900.SH','600908.SH','600909.SH','600917.SH','600919.SH','600926.SH','600933.SH','600936.SH','600939.SH','600958.SH','600959.SH','600965.SH','600967.SH','600970.SH','600971.SH','600973.SH','600975.SH','600977.SH','600978.SH','600986.SH','600987.SH','600988.SH','600990.SH','600993.SH','600996.SH','600998.SH','600999.SH','601000.SH','601001.SH','601002.SH','601003.SH','601006.SH','601009.SH','601012.SH','601015.SH','601016.SH','601018.SH','601019.SH','601020.SH','601021.SH','601058.SH','601069.SH','601088.SH','601098.SH','601099.SH','601100.SH','601108.SH','601111.SH','601116.SH','601117.SH','601127.SH','601128.SH','601139.SH','601155.SH','601158.SH','601166.SH','601168.SH','601169.SH','601179.SH','601186.SH','601198.SH','601199.SH','601200.SH','601211.SH','601212.SH','601216.SH','601222.SH','601225.SH','601228.SH','601229.SH','601231.SH','601233.SH','601238.SH','601288.SH','601311.SH','601318.SH','601328.SH','601333.SH','601336.SH','601360.SH','601368.SH','601375.SH','601377.SH','601390.SH','601398.SH','601515.SH','601555.SH','601567.SH','601588.SH','601595.SH','601600.SH','601601.SH','601607.SH','601608.SH','601611.SH','601618.SH','601628.SH','601633.SH','601636.SH','601666.SH','601668.SH','601669.SH','601678.SH','601688.SH','601689.SH','601699.SH','601717.SH','601718.SH','601727.SH','601766.SH','601777.SH','601788.SH','601789.SH','601799.SH','601800.SH','601801.SH','601808.SH','601811.SH','601818.SH','601828.SH','601838.SH','601857.SH','601858.SH','601866.SH','601872.SH','601877.SH','601878.SH','601880.SH','601881.SH','601888.SH','601890.SH','601898.SH','601899.SH','601901.SH','601908.SH','601919.SH','601928.SH','601933.SH','601939.SH','601958.SH','601966.SH','601969.SH','601985.SH','601988.SH','601989.SH','601991.SH','601992.SH','601997.SH','601998.SH','603000.SH','603007.SH','603008.SH','603019.SH','603025.SH','603056.SH','603060.SH','603077.SH','603080.SH','603098.SH','603103.SH','603106.SH','603108.SH','603111.SH','603113.SH','603118.SH','603126.SH','603128.SH','603160.SH','603165.SH','603168.SH','603169.SH','603180.SH','603188.SH','603198.SH','603225.SH','603228.SH','603233.SH','603239.SH','603258.SH','603260.SH','603288.SH','603298.SH','603300.SH','603305.SH','603306.SH','603328.SH','603337.SH','603338.SH','603339.SH','603355.SH','603357.SH','603358.SH','603363.SH','603368.SH','603369.SH','603377.SH','603387.SH','603421.SH','603444.SH','603515.SH','603517.SH','603533.SH','603556.SH','603567.SH','603568.SH','603569.SH','603579.SH','603585.SH','603588.SH','603589.SH','603595.SH','603599.SH','603600.SH','603603.SH','603609.SH','603612.SH','603618.SH','603619.SH','603626.SH','603628.SH','603639.SH','603658.SH','603659.SH','603660.SH','603669.SH','603686.SH','603707.SH','603711.SH','603728.SH','603730.SH','603737.SH','603757.SH','603766.SH','603776.SH','603798.SH','603799.SH','603803.SH','603806.SH','603816.SH','603818.SH','603833.SH','603848.SH','603858.SH','603861.SH','603866.SH','603868.SH','603877.SH','603881.SH','603883.SH','603885.SH','603888.SH','603895.SH','603898.SH','603899.SH','603929.SH','603939.SH','603959.SH','603989.SH','603993.SH','603997.SH']